define(["jquery","lmd/core/storage","lmd/ui/lecture-zen","lmd/ui/lightbox","lmd/core/service","lmd/core/auth","hoganpower!/partials/layout/tracking/decouverte_zen_register.html.mu@www"],function($,storage,lectureZen,Lightbox,service,auth,popinTemplate){var messages={erreurs:{generique:"Une erreur s'est produite. Veuillez v\u00e9rifier les renseignements fournis.",nom:"<strong>Merci de renseigner votre </strong>Nom",prenom:"<strong>Merci de renseigner votre </strong>Pr\u00e9nom",email:"<strong>Merci de renseigner votre </strong>Adresse e-mail",
email_incorrect:"Adresse email incorrecte."},erreurs_participation:{deja_joue_meme_operation:'Vous avez d\u00e9j\u00e0 profit\u00e9 de cette offre d\u00e9couverte, vous ne pouvez en profiter \u00e0 nouveau.<br /> Pour retrouver tous les services abonn\u00e9s, <a href="/cgi-bin/ACHATS/acheter.cgi?produit_id=185&offre=JELEC&mdp=3&promo_id=&op=acheter_produit&choix_produit=on&clef=TUNNELDECOUV">abonnez-vous \u00e0 partir de 1\u20ac.</a>',deja_joue_max:'Vous avez d\u00e9j\u00e0 profit\u00e9 \u00e0 deux reprises de l\'offre d\u00e9couverte Le Monde.fr<br />Pour b\u00e9n\u00e9ficier de tous les services abonn\u00e9s, <a href="/cgi-bin/ACHATS/acheter.cgi?produit_id=185&offre=JELEC&mdp=3&promo_id=&op=acheter_produit&choix_produit=on&clef=TUNNELDECOUV">abonnez-vous \u00e0 partir de 1\u20ac</a>',
max_participation:"Vous ne pourrez plus b\u00e9n\u00e9ficier de l'offre d\u00e9couverte",deja_abonne:"Vous b\u00e9n\u00e9ficiez d\u00e9j\u00e0 d'un acc\u00e8s a l'\u00c9dition abonn\u00e9s avec cette adresse e-mail.<br />Vous pouvez vous authentifier avec vos identifiants habituels.",erreur_abo:"Une erreur est survenue lors de votre abonnement"}};var operation_id;var lightbox={overlay:".fond_overlay.offre_decouverte",wrapper:".overlay.offre_decouverte",button:".fermer_offre_decouverte",top:85,overlayClose:false,
overlaySpeedIn:250,overlaySpeedout:250};var instance=null;var singleton=function(){var OffreDecouverteZen=function(){var self=this;if(document.location.pathname==="/")return;if(lmd.conf.decouverte_no_count.indexOf(document.location.pathname)>=0)return;if(document.location.pathname===lmd.conf.url_teaser_ex_decouverte)return;auth.loadUser().done(function(){if(!auth.authenticated||!auth.user.abonne)self.init()})};OffreDecouverteZen.prototype={init:function(){var self=this;var views=storage.get("lmd_decouverte_cpt")||
{page_count:0,already_shown:false,url:""};var period=12096E5;var today=new Date;var ex_abo=storage.get("lmd_decouverte")||{};if(views.url!==document.location.href&&!views.already_shown){views.url=document.location.href;views.page_count++;if(views.page_count>=parseInt(lmd.conf.limit_wall)&&ex_abo.is_abo===true)if(today.getTime()>ex_abo.date_fin){views.url=document.location.href;storage.set("lmd_decouverte_cpt",views,period);window.location.href=lmd.conf.url_teaser_ex_decouverte}if(views.page_count>=
parseInt(lmd.conf.limit_wall)&&lmd.context.item!=undefined&&lmd.context.item.type!=undefined&&lmd.context.item.type.nom!=undefined&&lmd.context.item.type.nom==="article"){views.already_shown=true;operation_id=lmd.conf.offre_decouverte_avec_abo_auto;self.afficherLectureZen()}storage.set("lmd_decouverte_cpt",views,period)}if(lectureZen.getInstance().bouton)lectureZen.getInstance().bouton.addClass("btn_offre_decouverte_zen").on("click",function(){self.boutonLectureZenXiti();operation_id=lmd.conf.offre_decouverte_zen_avec_abo_auto;
self.afficherLectureZen()})},afficherLectureZen:function(){var self=this;lectureZen.getInstance().open(function(){lectureZen.getInstance().lightbox.instance.disableClosing=true;var count=0;var interval=setInterval(function(){count+=1E3;if(count>=lmd.conf.decouverte_zen_delay){self.afficherFormulaire();clearInterval(interval)}},1E3)})},afficherFormulaire:function(){var self=this;this.lightbox=new Lightbox(lightbox);this.lightbox.setLoader(true);this.lightbox.on("open",function(){lectureZen.getInstance().lightbox.instance.disableClosing=
false;self.setupFormulaire();self.loadXiti();$("#no_thanks").click(function(){self.lightbox.close()})});this.lightbox.on("close",function(){if(!auth.authenticated||!auth.user.abonne)lectureZen.getInstance().lightbox.close();else lectureZen.getInstance().loadXiti()});this.lightbox.open(popinTemplate.render({conf:lmd.conf,operation_id:operation_id,popin_class:self.getPopinClass()}))},setupFormulaire:function(){var self=this;$("#decouverte input").on("focus change",function(){$(this).removeClass("saisie_erreur")});
$("#decouverte").on("submit",function(event){event.preventDefault();var url_creation_compte="marketing/decouverte/abo";$("#erreur").hide();var spinner=(new Spinner({radius:5,length:5,width:2})).spin();$("#submit",this).append($(spinner.el).css({top:-20,left:375}));self.checkFormulaire().then(function(){service.get(url_creation_compte,1,{email:$("#email").val(),nom:$("#nom").val(),prenom:$("#prenom").val(),operation_id:$("#operation_id").val(),optin:$("#optin").is(":checked")},{timeout:15E3}).done(function(data){if(data.msg===
null||data.msg===""){self.hitXiti();self.poserParticipation(true);self.loguerUser(data.password)}else switch(data.msg){case "4000":$("#erreur").html(messages.erreurs_participation.deja_abonne).show();break;case "4400":$("#erreur").html(messages.erreurs_participation.deja_joue_max).show();break;default:$("#erreur").html(messages.erreurs_participation.erreur_abo).show();break}spinner.stop()}).fail(function(response){$("#erreur").html(messages.erreurs.generique).show();spinner.stop()})},function(errors){$("#erreur").html(errors.join("<br />")).show();
spinner.stop()})})},checkFormulaire:function(){var promise=new $.Deferred;var url_service_check="marketing/decouverte/check";var regexp_email=new RegExp("^[0-9a-z._-]+@{1}[0-9a-z.-]{2,}[.]{1}[a-z]{2,6}$","i");var errors=[];if($("#prenom").val()===""){$("#prenom").addClass("saisie_erreur");errors.push(messages["erreurs"]["prenom"])}if($("#nom").val()===""){$("#nom").addClass("saisie_erreur");errors.push(messages["erreurs"]["nom"])}if($("#email").val()===""){$("#email").addClass("saisie_erreur");errors.push(messages["erreurs"]["email"])}else if(!regexp_email.test($("#email").val())){$("#email").addClass("saisie_erreur");
errors.push(messages["erreurs"]["email_incorrect"])}if(errors.length===0)service.get(url_service_check,1,{email:$("#email").val(),operation_id:$("#operation_id").val()}).done(function(data){if(data.participation!==""&&data.participation!=="max_participation"){$("#max_participation").attr("value","");promise.reject([messages.erreurs_participation[data.participation]])}else if(data.participation==="max_participation"){$("#max_participation").attr("value","max_participation");promise.resolve("max_participation")}else{$("#max_participation").attr("value",
"");promise.resolve()}}).fail(function(response){var res=JSON.parse(response.responseText);promise.reject([messages.erreurs.generique,res.error.message])});if(errors.length!==0)promise.reject(errors);return promise},loadXiti:function(){switch(operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:xt_med("F","19","Inscription_offre_decouverte::Lemondefr::Affichage_formulaire");break;case lmd.conf.offre_decouverte_zen_avec_abo_auto:xt_med("F","19","Inscription_offre_decouverte::Lemondefr::Affichage_formulaire_bouton_lecture_zen");
break}},hitXiti:function(){var form=document.getElementById("decouverte");switch(operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:return xt_form(form,"C","19","Inscription_offre_decouverte::Lemondefr::Validation_formulaire","A",false);case lmd.conf.offre_decouverte_zen_avec_abo_auto:return xt_form(form,"C","19","Inscription_offre_decouverte::Lemondefr::Validation_formulaire_bouton_lecture_zen","A",false)}},boutonLectureZenXiti:function(){xt_click(lectureZen.getInstance().bouton.get(0),"C",
"19","Offre_decouverte::Lemonde.fr::Bouton_lecture_zen","A")},poserParticipation:function(abo){var expire_ts=5184E6;var today=new Date;var date_fin_abo=today.getTime()+12096E5;var user_cookie={is_abo:true,participation:today.getTime(),date_abo:null,date_fin:date_fin_abo};if(abo)user_cookie.date_abo=today.getTime();storage.set("lmd_decouverte",user_cookie,expire_ts,false)},loguerUser:function(passwd){var self=this;var user={login:$("#email").val(),password:passwd,sauv_login:false};auth.login(user,
true).done(function(response){if(response.result)auth.loadUser(true).done(function(){$("#confirmation").show();setTimeout(function(){self.lightbox.close();self.showHelp()},3E3);lectureZen.getInstance().lightbox.on("close",function(){window.location.reload()})})})},showHelp:function(){var message="Cliquez ici pour quitter la lecture zen";var popin=$('<div class="conteneur_popinbox_wrapper"><div class="conteneur_popinbox"></div><div class="popin">'+message+"</div></div>");$(".fermer_lecture_zen").append(popin);
popin.show()},getPopinClass:function(){switch(operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:return"offre-decouverte-3-pages";case lmd.conf.offre_decouverte_zen_avec_abo_auto:return"offre-decouverte-lecture-zen"}}};return{getInstance:function(){if(instance===null)instance=new OffreDecouverteZen;return instance}}}();return singleton});
